<?php

/**
 * @file
 * Contains iq_faq.module.
 */

use Drupal\Core\Url;

/**
 * Implements hook_metatags_alter().
 *
 * Read FAQ data from node and add it to metagas.
 */
function iq_faq_metatags_alter(array &$metatags) {

  foreach (\Drupal::routeMatch()->getParameters()->all() as $entityType => $entity) {
    $builder = \Drupal::service('entity_type.manager')->getViewBuilder($entityType);
    $build = $builder->view($entity, 'full');
    $output = \Drupal::service('renderer')->renderPlain($build);

    $dom = new DOMDocument();
    $dom->loadHTML($output, LIBXML_NOERROR);
    $finder = new DomXPath($dom);

    // Search content for iq-faq-item elements.
    $questions = iterator_to_array($finder->query("//*[contains(concat(' ', normalize-space(@class), ' '), ' iq-faq-item-question ')]"));
    $answers = iterator_to_array($finder->query("//*[contains(concat(' ', normalize-space(@class), ' '), ' iq-faq-item-answer ')]"));

    if (count($questions)) {
      if (array_key_exists('schema_qa_page_main_entity', $metatags)) {
        $schemaFAQ = unserialize($metatags['schema_qa_page_main_entity']);
      }
      else {
        $schemaFAQ = [
          'pivot' => 1,
          '@type' => 'Question',
          'name'  => '',
          'acceptedAnswer' => [
            'pivot' => 1,
            '@type' => 'Answer',
            'text'  => '',
          ],
        ];
      }

      $questions = array_map(function ($question) {
        return trim(strip_tags($question->ownerDocument->saveXML($question)));
      }, $questions);

      $answers = array_map(function ($answer) {
        return trim(strip_tags($answer->ownerDocument->saveXML($answer)));
      }, $answers);

      $schemaFAQ['name'] = trim(implode('::', array_merge(explode('::', trim($schemaFAQ['name'], '::')), $questions)), '::');
      $schemaFAQ['acceptedAnswer']['text'] = trim(implode('::', array_merge(explode('::', trim($schemaFAQ['acceptedAnswer']['text'], '::')), $answers)), '::');
      $schemaFAQ['acceptedAnswer']['url'] = Url::fromRoute('<current>', [], ["absolute" => TRUE])->toString();
      $metatags['schema_qa_page_type'] = 'FAQPage';
      $metatags['schema_qa_page_main_entity'] = serialize($schemaFAQ);
    }
  }

}
